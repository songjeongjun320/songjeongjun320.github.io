AWS EC2와 HTTPS 로드 밸런서 설정: 문제 해결 가이드
이번 포스트에서는 AWS EC2 인스턴스와 HTTPS 로드 밸런서를 설정하고, Vercel에서 배포한 클라이언트와 통신을 설정하면서 겪었던 문제와 해결 과정을 공유하려고 합니다. 이 가이드는 비전공자도 이해할 수 있도록 최대한 쉽게 설명하며, 발생 가능한 오류와 해결 방법에 대해 다룹니다.

1. 배경
AWS EC2 인스턴스에 AI 관련 로직을 배포하고, Vercel에서 클라이언트 페이지를 만들어 AWS EC2와 통신하는 환경을 구성했습니다. 개발 중에는 HTTP 프로토콜로 테스트가 잘 되었지만, 실제 배포 환경에서는 HTTPS를 요구하므로 SSL 인증서를 적용해 HTTPS 로드 밸런서를 설정하는 과정이 필요했습니다.

2. 문제 해결 과정
문제 1: HTTPS 설정에서 발생하는 리다이렉션 문제
증상
Vercel 클라이언트에서 EC2 서버에 HTTPS 요청을 보내면, HTTP와 HTTPS 간의 리다이렉션이 발생하면서 요청이 정상적으로 처리되지 않았습니다.

해결 방법

로드 밸런서에 HTTPS 리스너 추가: HTTPS 요청을 처리하기 위해 로드 밸런서에 HTTPS 리스너(포트 443)를 추가했습니다.
리다이렉션 설정: HTTP 요청(포트 80)을 HTTPS 요청(포트 443)으로 리다이렉트하도록 설정했습니다. 이렇게 함으로써 클라이언트가 HTTP로 접근해도 HTTPS로 자동 전환되도록 했습니다.
문제 2: AWS SSL 인증서 설정 및 할당 오류
증상
로드 밸런서에 HTTPS를 설정하기 위해 SSL 인증서가 필요했으나, 올바른 인증서가 로드 밸런서에 적용되지 않아 HTTPS 접속이 불가능했습니다.

해결 방법

AWS Certificate Manager(ACM)에서 인증서 발급: 도메인(jeongjunsong.com)에 대한 인증서를 ACM에서 발급받았습니다.
도메인 확인: ACM에서 발급받은 인증서가 정상적으로 확인되었는지 확인했습니다. Route 53을 사용해 도메인의 DNS 설정을 업데이트하고, CNAME을 통해 인증서 확인을 완료했습니다.
로드 밸런서에 인증서 할당: 발급된 SSL 인증서를 로드 밸런서의 HTTPS 리스너에 연결했습니다.
문제 3: EC2 인스턴스 포트 및 보안 그룹 설정 문제
증상
EC2 인스턴스의 포트 설정 문제로 인해, 로드 밸런서가 EC2 인스턴스와 통신하지 못했습니다.

해결 방법

보안 그룹 설정 확인: EC2 인스턴스와 로드 밸런서의 보안 그룹이 올바르게 설정되어 있는지 확인했습니다. HTTPS(포트 443)와 HTTP(포트 80)를 허용하는 규칙을 추가했습니다.
로드 밸런서 대상 그룹에 포트 5000 설정: 로드 밸런서가 EC2 인스턴스의 5000번 포트에 접근할 수 있도록 대상 그룹을 설정했습니다. EC2 인스턴스의 보안 그룹에서도 포트 5000에 대한 인바운드 규칙을 추가했습니다.
문제 4: Route 53 DNS 설정 문제
증상
Route 53에 도메인 등록은 완료되었으나, 올바른 레코드 설정이 없어 도메인이 로드 밸런서와 연결되지 않았습니다.

해결 방법

A 레코드 설정: jeongjunsong.com의 루트 도메인에 대해 A 레코드 (Alias)를 생성하고, 로드 밸런서의 DNS 이름을 Alias 대상으로 설정했습니다.
CNAME 설정: 서브도메인(www.jeongjunsong.com)의 경우 CNAME을 사용해 로드 밸런서의 DNS 이름으로 설정했습니다.
3. 최종 설정 확인 및 테스트
로드 밸런서 URL 테스트: https://test-1722148449.us-west-1.elb.amazonaws.com 형식의 로드 밸런서 URL로 접속해 HTTPS가 정상적으로 동작하는지 확인했습니다.
커스텀 도메인 테스트: https://jeongjunsong.com 도메인을 통해 접속하여 SSL 인증서가 정상적으로 동작하는지 확인했습니다.
Vercel 클라이언트와의 통신 테스트: Vercel에서 배포한 클라이언트에서 API 요청을 보냈을 때, HTTPS 통신이 정상적으로 이루어지는지 확인했습니다.
4. 추가 문제 및 해결 과정
문제 5: JSON 파일 불러오기 오류
증상
Vercel 클라이언트에서 API 호출 시 JSON 파일을 읽어오는 과정에서 404 오류가 발생했습니다.

해결 방법

API 경로 확인: 클라이언트에서 요청하는 API 경로가 정확한지 확인했습니다. 서버에서 제공하는 API 경로와 일치해야 합니다.
로깅 추가: 클라이언트와 서버 양쪽에 로깅을 추가하여, 요청과 응답의 흐름을 추적했습니다. 오류가 발생한 경우에는 관련 로그를 확인하여 문제의 원인을 파악했습니다.
문제 6: 파일 시스템 접근 오류
증상
서버에서 파일을 저장할 때 EROFS: read-only file system 오류가 발생했습니다.

해결 방법

AWS Lambda와 Vercel과 같은 서버리스 환경에서는 /tmp 디렉토리만 쓰기 권한이 있습니다. 따라서 파일 저장 경로를 /tmp로 변경하여 문제를 해결했습니다.
5. 결론
이번 설정 과정에서 겪은 문제는 HTTPS 설정, SSL 인증서 발급 및 할당, EC2 보안 그룹 설정, Route 53 DNS 설정, JSON 파일 읽기 오류 및 파일 시스템 접근 오류 등이었습니다. 각 문제를 차례로 해결하면서 로드 밸런서를 통해 HTTPS 통신을 안정적으로 설정할 수 있었습니다.

이 가이드를 통해 AWS EC2와 HTTPS 로드 밸런서를 설정하는 과정에서 발생할 수 있는 문제와 해결 방법을 공유했습니다. 비슷한 환경을 구축하려는 분들께 도움이 되길 바랍니다.